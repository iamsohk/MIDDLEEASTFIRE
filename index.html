<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDDLE EAST FIRE TEAM DASHBOARD</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: 工業風/機械字體 -->
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // =========================================================================
        //  FIREBASE 設定區
        // =========================================================================
        
        const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const envAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const envAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // [已確認：你的 Config 設定正確]
        const manualConfig = {
            apiKey: "AIzaSyDZfiar_D0bAhlkZFqc_9RqUIO6XTT7UtQ",
            authDomain: "fire-team-dashboard.firebaseapp.com",
            projectId: "fire-team-dashboard",
            storageBucket: "fire-team-dashboard.firebasestorage.app",
            messagingSenderId: "270034667438",
            appId: "1:270034667438:web:cc98aa925e2105fbd4aa3f"
        };

        // 智能切換：預覽時用 AI 環境，GitHub 時用你的 Manual Config
        const firebaseConfig = envConfig || manualConfig;
        const appId = envAppId;

        let db, auth, currentUser;

        async function initApp() {
            try {
                // 初始化
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 處理登入
                if (envAuthToken) {
                    await signInWithCustomToken(auth, envAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 監聽登入狀態
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        console.log("System Status: User Authenticated");
                    }
                });

            } catch (e) {
                console.error("Firebase Init Error:", e);
                alert("系統連線失敗，請檢查 Firebase Console 是否已開通 Database");
            }
        }

        initApp();
        
        // --- 天氣功能 ---
        async function fetchWeather() {
            try {
                const response = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=tc');
                const data = await response.json();
                const temp = data.temperature.data[0].value;
                const iconId = data.icon[0];
                const iconUrl = `https://www.hko.gov.hk/images/HKOWxIconOutline/pic${iconId}.png`;
                
                document.getElementById('weather-temp').innerText = `${temp}°C`;
                document.getElementById('weather-icon').src = iconUrl;
                document.getElementById('weather-desc').innerText = "HONG KONG";
            } catch (error) {
                console.error("Weather Error", error);
            }
        }
        fetchWeather();
        setInterval(fetchWeather, 1800000);


        // --- 核心邏輯部分 ---

        // [關鍵修正] 智能路徑選擇器
        // 目的：在 GitHub 用簡潔路徑 (tasks)，在 AI 預覽用長路徑
        function getCollectionRef(colName) {
             if (envConfig) {
                 // AI 預覽環境 (必須)
                 return collection(db, 'artifacts', appId, 'public', 'data', colName);
             } else {
                 // GitHub / 正式環境 (簡潔路徑，方便你在 Console 管理)
                 return collection(db, colName);
             }
        }

        window.checkPass = () => {
            const pass = document.getElementById('access-code').value;
            if (pass === '8888') {
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                if (currentUser) {
                    initRealtimeListeners();
                } else {
                    setTimeout(() => {
                         if(currentUser) initRealtimeListeners();
                         else alert("正在連線到數據庫，請稍候...");
                    }, 1000);
                }
            } else {
                const errorMsg = document.getElementById('error-msg');
                errorMsg.classList.remove('hidden');
                setTimeout(() => errorMsg.classList.add('hidden'), 2000);
            }
        };

        function initRealtimeListeners() {
            if (!db || !currentUser) return;

            // Tasks 監聽
            const tasksRef = getCollectionRef("tasks");
            const qTasks = query(tasksRef, orderBy("createdAt", "desc"));
            
            onSnapshot(qTasks, (snapshot) => {
                const list = document.getElementById('todo-list');
                list.innerHTML = ''; 
                if (snapshot.empty) list.innerHTML = '<li class="text-center text-gray-400 font-mono py-4">暫無任務 // NO DATA</li>';

                snapshot.forEach((docSnap) => {
                    const task = docSnap.data();
                    const id = docSnap.id;
                    const li = document.createElement('li');
                    li.className = `p-3 mb-2 border-l-4 ${task.done ? 'bg-gray-100 border-green-600 opacity-60' : 'bg-white border-yellow-500 shadow-sm'} border border-gray-200 flex justify-between items-center group transition-all hover:bg-gray-50`;
                    li.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <button onclick="toggleTask('${id}', ${task.done})" class="w-5 h-5 border-2 border-gray-400 flex items-center justify-center hover:border-black">
                                ${task.done ? '<div class="w-3 h-3 bg-green-600"></div>' : ''}
                            </button>
                            <span class="${task.done ? 'line-through text-gray-400' : 'text-gray-800 font-bold'} font-mono text-sm break-all">${task.text}</span>
                        </div>
                        <button onclick="deleteItem('tasks', '${id}')" class="text-red-900 hover:text-red-600 font-bold px-2 opacity-0 group-hover:opacity-100 transition-opacity">X</button>
                    `;
                    list.appendChild(li);
                });
            });

            // Notes 監聽
            const notesRef = getCollectionRef("notes");
            const qNotes = query(notesRef, orderBy("createdAt", "desc"));
            
            onSnapshot(qNotes, (snapshot) => {
                const container = document.getElementById('notes-container');
                container.innerHTML = '';
                if (snapshot.empty) container.innerHTML = '<div class="text-center text-gray-400 font-mono py-4 col-span-1">暫無筆記 // NO NOTES</div>';

                snapshot.forEach((docSnap) => {
                    const note = docSnap.data();
                    const id = docSnap.id;
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 border-2 border-gray-800 shadow-[4px_4px_0px_rgba(0,0,0,0.8)] relative group transform hover:-translate-y-1 transition-transform";
                    div.innerHTML = `
                        <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-300 rounded-full border border-gray-400 shadow-inner"></div>
                        <p class="font-mono text-sm text-gray-800 whitespace-pre-wrap font-bold">${note.text}</p>
                        <div class="mt-4 text-xs text-gray-500 border-t border-gray-200 pt-2 flex justify-between items-center">
                            <span class="bg-gray-200 px-1 text-black font-mono">BY: ${note.author || '同事'}</span>
                            <button onclick="deleteItem('notes', '${id}')" class="text-red-600 font-bold opacity-0 group-hover:opacity-100 hover:underline">DELETE</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            });
        }

        window.addTask = async () => {
            const input = document.getElementById('todo-input');
            const text = input.value.trim();
            if (!text || !db || !currentUser) return;
            try {
                const tasksRef = getCollectionRef("tasks");
                await addDoc(tasksRef, {
                    text: text,
                    done: false,
                    createdAt: serverTimestamp(),
                    createdBy: currentUser.uid
                });
                input.value = ''; 
            } catch (e) { 
                console.error(e); 
                alert("新增失敗：請確認 Firestore 已設定為 Test Mode");
            }
        };

        window.addNote = async () => {
            const input = document.getElementById('note-input');
            const authorInput = document.getElementById('note-author');
            const text = input.value.trim();
            const author = authorInput.value.trim() || '某同事';
            if (!text || !db || !currentUser) return;
            try {
                const notesRef = getCollectionRef("notes");
                await addDoc(notesRef, {
                    text: text,
                    author: author,
                    createdAt: serverTimestamp(),
                    createdBy: currentUser.uid
                });
                input.value = '';
            } catch (e) { 
                console.error(e);
                alert("新增失敗：請確認 Firestore 已設定為 Test Mode");
            }
        };

        // [修正] 確保 toggle 同 delete 都用到正確路徑
        window.toggleTask = async (id, currentStatus) => {
            if(!db || !currentUser) return;
            try {
                const colRef = getCollectionRef("tasks"); // 用 helper 攞路徑
                const taskDocRef = doc(colRef, id);
                await updateDoc(taskDocRef, { done: !currentStatus });
            } catch(e) { console.error(e); }
        };

        window.deleteItem = async (colName, id) => {
            if(!db || !currentUser) return;
            if(confirm('確定刪除？')) {
                try {
                    const colRef = getCollectionRef(colName); // 用 helper 攞路徑
                    const itemDocRef = doc(colRef, id);
                    await deleteDoc(itemDocRef);
                } catch(e) { console.error(e); }
            }
        };
        
        document.getElementById('todo-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') window.addTask();
        });
    </script>

    <style>
        /* 淺色工業風樣式 */
        body {
            background-color: #f0f0f0; 
            color: #111;
            background-image: 
                linear-gradient(#ccc 1px, transparent 1px),
                linear-gradient(90deg, #ccc 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: center center;
        }
        .font-industrial { font-family: 'Black Ops One', cursive; }
        .hazard-stripe {
            background: repeating-linear-gradient(45deg, #FFD700, #FFD700 10px, #111 10px, #111 20px);
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e5e5e5; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0);
