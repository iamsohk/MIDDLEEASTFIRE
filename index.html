<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDDLE EAST FIRE TEAM DASHBOARD</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: 工業風/機械字體 -->
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // =========================================================================
        //  FIREBASE 設定區 (請注意這裡！)
        // =========================================================================
        
        // 1. 偵測是否在 AI 預覽環境
        const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const envAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const envAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // 2. [⚠️ 部署到 GITHUB 必須修改這裡 ⚠️] 
        // 請去 Firebase Console -> Project Settings -> General -> Your apps (Web) 複製設定
        const manualConfig = {
            apiKey: "你的_API_KEY",
            authDomain: "你的_PROJECT_ID.firebaseapp.com",
            projectId: "你的_PROJECT_ID",
            storageBucket: "你的_PROJECT_ID.appspot.com",
            messagingSenderId: "你的_SENDER_ID",
            appId: "你的_APP_ID"
        };

        // 決定使用哪組設定 (如果在 GitHub，envConfig 會是 null，所以會用 manualConfig)
        const firebaseConfig = envConfig || manualConfig;
        const appId = envAppId;

        let db, auth, currentUser;

        async function initApp() {
            try {
                // [防呆檢查] 如果在 GitHub 環境但未填 Config，彈出警告
                if (!envConfig && manualConfig.apiKey.includes("你的_API_KEY")) {
                    alert("⚠️ 設定錯誤！\n\n你未填寫 Firebase Config。\n請用記事本打開 index.html，在 'manualConfig' 位置填入你的 API Key 和 Project ID。\n\n否則 Mission Log 和 Notes 無法運作。");
                    
                    const errorHtml = '<li class="text-center text-red-600 font-bold py-4 bg-red-100 border border-red-500">錯誤：請修改 index.html 內的 manualConfig</li>';
                    document.getElementById('todo-list').innerHTML = errorHtml;
                    document.getElementById('notes-container').innerHTML = errorHtml;
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 處理登入
                if (envAuthToken) {
                    await signInWithCustomToken(auth, envAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        console.log("已登入:", user.uid);
                    }
                });

            } catch (e) {
                console.error("Firebase 初始化失敗:", e);
                alert("數據庫連線失敗，請檢查 Config 是否正確。");
            }
        }

        initApp();
        
        // --- 天氣功能 ---
        async function fetchWeather() {
            try {
                const response = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=tc');
                const data = await response.json();
                const temp = data.temperature.data[0].value;
                const iconId = data.icon[0];
                const iconUrl = `https://www.hko.gov.hk/images/HKOWxIconOutline/pic${iconId}.png`;
                
                document.getElementById('weather-temp').innerText = `${temp}°C`;
                document.getElementById('weather-icon').src = iconUrl;
                document.getElementById('weather-desc').innerText = "HONG KONG";
                
            } catch (error) {
                console.error("天氣讀取失敗", error);
                document.getElementById('weather-desc').innerText = "天氣載入失敗";
            }
        }
        
        fetchWeather();
        setInterval(fetchWeather, 1800000);


        // --- 核心邏輯部分 ---

        window.checkPass = () => {
            const pass = document.getElementById('access-code').value;
            if (pass === '8888') {
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                
                // 嘗試初始化監聽器
                if (currentUser) {
                    initRealtimeListeners();
                } else {
                    // 如果網絡慢，稍等一下
                    setTimeout(() => {
                         if(currentUser) initRealtimeListeners();
                         else console.log("等待登入..."); 
                    }, 1000);
                }
            } else {
                const errorMsg = document.getElementById('error-msg');
                errorMsg.classList.remove('hidden');
                setTimeout(() => errorMsg.classList.add('hidden'), 2000);
            }
        };

        // [關鍵修正] 取得資料庫路徑
        function getCollectionRef(colName) {
             // 情況 A: AI 預覽環境 (必須用 artifacts 路徑)
             if (envConfig) {
                 return collection(db, 'artifacts', appId, 'public', 'data', colName);
             }
             
             // 情況 B: GitHub / 正式環境 (直接用 Root Collection，簡單直接)
             // 這樣你在 Firebase Console 直接點 "tasks" 就看到資料
             return collection(db, colName);
        }

        function initRealtimeListeners() {
            if (!db || !currentUser) return;

            // Tasks
            const tasksRef = getCollectionRef("tasks");
            const qTasks = query(tasksRef, orderBy("createdAt", "desc"));
            
            onSnapshot(qTasks, (snapshot) => {
                const list = document.getElementById('todo-list');
                list.innerHTML = ''; 
                
                if (snapshot.empty) {
                     list.innerHTML = '<li class="text-center text-gray-400 font-mono py-4">暫無任務 // NO DATA</li>';
                }

                snapshot.forEach((docSnap) => {
                    const task = docSnap.data();
                    const id = docSnap.id;
                    
                    const li = document.createElement('li');
                    li.className = `p-3 mb-2 border-l-4 ${task.done ? 'bg-gray-100 border-green-600 opacity-60' : 'bg-white border-yellow-500 shadow-sm'} border border-gray-200 flex justify-between items-center group transition-all hover:bg-gray-50`;
                    li.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <button onclick="toggleTask('${id}', ${task.done})" class="w-5 h-5 border-2 border-gray-400 flex items-center justify-center hover:border-black">
                                ${task.done ? '<div class="w-3 h-3 bg-green-600"></div>' : ''}
                            </button>
                            <span class="${task.done ? 'line-through text-gray-400' : 'text-gray-800 font-bold'} font-mono text-sm break-all">${task.text}</span>
                        </div>
                        <button onclick="deleteItem('tasks', '${id}')" class="text-red-900 hover:text-red-600 font-bold px-2 opacity-0 group-hover:opacity-100 transition-opacity">X</button>
                    `;
                    list.appendChild(li);
                });
            }, (error) => {
                console.error("讀取 Tasks 錯誤:", error);
                // 如果權限不足，會在 Console 顯示
            });

            // Notes
            const notesRef = getCollectionRef("notes");
            const qNotes = query(notesRef, orderBy("createdAt", "desc"));
            
            onSnapshot(qNotes, (snapshot) => {
                const container = document.getElementById('notes-container');
                container.innerHTML = '';

                if (snapshot.empty) {
                     container.innerHTML = '<div class="text-center text-gray-400 font-mono py-4 col-span-1">暫無筆記 // NO NOTES</div>';
                }

                snapshot.forEach((docSnap) => {
                    const note = docSnap.data();
                    const id = docSnap.id;
                    
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 border-2 border-gray-800 shadow-[4px_4px_0px_rgba(0,0,0,0.8)] relative group transform hover:-translate-y-1 transition-transform";
                    div.innerHTML = `
                        <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-300 rounded-full border border-gray-400 shadow-inner"></div>
                        <p class="font-mono text-sm text-gray-800 whitespace-pre-wrap font-bold">${note.text}</p>
                        <div class="mt-4 text-xs text-gray-500 border-t border-gray-200 pt-2 flex justify-between items-center">
                            <span class="bg-gray-200 px-1 text-black font-mono">BY: ${note.author || '同事'}</span>
                            <button onclick="deleteItem('notes', '${id}')" class="text-red-600 font-bold opacity-0 group-hover:opacity-100 hover:underline">DELETE</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            });
        }

        window.addTask = async () => {
            const input = document.getElementById('todo-input');
            const text = input.value.trim();
            if (!text || !db || !currentUser) return;
            try {
                const tasksRef = getCollectionRef("tasks");
                await addDoc(tasksRef, {
                    text: text,
                    done: false,
                    createdAt: serverTimestamp(),
                    createdBy: currentUser.uid
                });
                input.value = ''; 
            } catch (e) { 
                console.error(e); 
                alert("新增失敗，請檢查 Firebase 權限或網絡");
            }
        };

        window.addNote = async () => {
            const input = document.getElementById('note-input');
            const authorInput = document.getElementById('note-author');
            const text = input.value.trim();
            const author = authorInput.value.trim() || '某同事';
            if (!text || !db || !currentUser) return;
            try {
                const notesRef = getCollectionRef("notes");
                await addDoc(notesRef, {
                    text: text,
                    author: author,
                    createdAt: serverTimestamp(),
                    createdBy: currentUser.uid
                });
                input.value = '';
            } catch (e) { 
                console.error(e);
                alert("新增失敗，請檢查 Firebase 權限或網絡");
            }
        };

        window.toggleTask = async (id, currentStatus) => {
            if(!db || !currentUser) return;
            try {
                // 這裡都要用 getCollectionRef 確保路徑一致
                const colRef = getCollectionRef("tasks");
                const taskDocRef = doc(colRef, id);
                await updateDoc(taskDocRef, { done: !currentStatus });
            } catch(e) { console.error(e); }
        };

        window.deleteItem = async (colName, id) => {
            if(!db || !currentUser) return;
            if(confirm('確定刪除？')) {
                try {
                    const colRef = getCollectionRef(colName);
                    const itemDocRef = doc(colRef, id);
                    await deleteDoc(itemDocRef);
                } catch(e) { console.error(e); }
            }
        };
        
        document.getElementById('todo-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') window.addTask();
        });
    </script>

    <style>
        /* 淺色工業風樣式 */
        body {
            background-color: #f0f0f0; /* 淺灰背景 */
            color: #111; /* 深黑文字 */
            /* 網格背景圖 */
            background-image: 
                linear-gradient(#ccc 1px, transparent 1px),
                linear-gradient(90deg, #ccc 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: center center;
        }
        
        .font-industrial {
            font-family: 'Black Ops One', cursive;
        }
        
        /* 警示條改為 黑/黃 配色 */
        .hazard-stripe {
            background: repeating-linear-gradient(
                45deg,
                #FFD700, /* 金黃 */
                #FFD700 10px,
                #111 10px,
                #111 20px
            );
        }

        /* 捲軸樣式 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e5e5e5; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center font-mono">

    <!-- 登入鎖定畫面 -->
    <div id="login-modal" class="fixed inset-0 z-50 bg-neutral-900 flex items-center justify-center p-4">
        <div class="bg-white border-4 border-black p-8 w-full max-w-md shadow-[8px_8px_0px_#FFD700] relative text-center">
            <!-- 警示條 -->
            <div class="hazard-stripe h-4 w-full absolute top-0 left-0 border-b-2 border-black"></div>
            
            <h1 class="text-3xl font-industrial text-black mt-6 mb-2 tracking-widest uppercase">Restricted Area</h1>
            <p class="font-mono text-gray-500 text-sm mb-6 bg-yellow-100 inline-block px-2">AUTH REQUIRED</p>
            
            <input type="password" id="access-code" placeholder="ENTER PASSCODE" 
                class="w-full bg-gray-100 border-2 border-black text-black font-mono text-center text-xl p-3 mb-4 focus:outline-none focus:bg-white placeholder-gray-400">
            
            <button onclick="checkPass()" 
                class="w-full bg-black hover:bg-gray-800 text-white font-bold font-mono py-3 px-4 transition-colors border-2 border-transparent hover:border-yellow-400">
                ACCESS SYSTEM >>
            </button>
            
            <p id="error-msg" class="text-red-600 font-bold mt-4 hidden blink">ACCESS DENIED</p>
            
            <div class="hazard-stripe h-4 w-full absolute bottom-0 left-0 border-t-2 border-black"></div>
        </div>
    </div>

    <!-- 主程式介面 -->
    <div id="main-app" class="w-full max-w-7xl p-4 hidden animate-fade-in mt-4">
        
        <!-- Header 區域 -->
        <header class="bg-white border-4 border-black p-6 mb-8 shadow-[8px_8px_0px_rgba(0,0,0,0.2)] flex flex-col md:flex-row justify-between items-center gap-6 relative overflow-hidden">
            <!-- 背景裝飾字 -->
            <div class="absolute -right-10 -top-10 text-9xl text-gray-100 font-industrial select-none z-0 opacity-50">FIRE</div>

            <!-- 左邊：標題 -->
            <div class="z-10 relative">
                <div class="flex items-center gap-2 mb-1">
                    <span class="bg-yellow-400 text-black text-xs font-bold px-2 py-0.5 border border-black">HK REGION</span>
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                </div>
                <h1 class="text-4xl md:text-5xl font-industrial text-black tracking-wider leading-tight">
                    MIDDLE EAST FIRE<br>TEAM DASHBOARD
                </h1>
            </div>

            <!-- 右邊：天氣 Widget (API) -->
            <div class="z-10 bg-gray-100 border-2 border-black p-3 min-w-[180px] text-center flex flex-col items-center shadow-md">
                <div class="text-xs font-bold text-gray-500 border-b border-gray-300 w-full mb-2 pb-1">WEATHER CONDITION</div>
                <div class="flex items-center justify-center gap-2">
                    <img id="weather-icon" src="" alt="Weather" class="w-10 h-10 object-contain">
                    <div class="text-3xl font-bold text-black font-industrial" id="weather-temp">--°C</div>
                </div>
                <div class="text-xs font-bold text-gray-600 mt-1" id="weather-desc">LOADING...</div>
            </div>
        </header>

        <!-- 內容區 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <!-- 左欄：TO-DO LIST -->
            <section class="bg-white border-4 border-black shadow-[8px_8px_0px_#ccc]">
                <div class="bg-black p-3 flex justify-between items-center text-white">
                    <h2 class="font-industrial text-xl tracking-wider text-yellow-400">>> MISSION LOG</h2>
                    <span class="text-xs font-mono bg-gray-800 px-2 py-1 border border-gray-600">PENDING TASKS</span>
                </div>
                
                <div class="p-6">
                    <!-- 輸入區 -->
                    <div class="flex gap-2 mb-6">
                        <input type="text" id="todo-input" placeholder="新增任務..." 
                            class="flex-1 bg-gray-100 border-2 border-black text-black font-mono p-3 focus:outline-none focus:bg-white placeholder-gray-500">
                        <button onclick="addTask()" class="bg-yellow-400 hover:bg-yellow-500 text-black px-6 font-bold font-mono border-2 border-black shadow-[2px_2px_0px_black] active:translate-y-1 active:shadow-none transition-all">
                            ADD
                        </button>
                    </div>

                    <!-- 列表區 -->
                    <ul id="todo-list" class="space-y-3 max-h-[500px] overflow-y-auto pr-2 custom-scroll">
                        <li class="text-center text-gray-400 font-mono py-4">SYSTEM CONNECTING...</li>
                    </ul>
                </div>
            </section>

            <!-- 右欄：筆記牆 -->
            <section class="bg-white border-4 border-black shadow-[8px_8px_0px_#ccc]">
                <div class="bg-black p-3 flex justify-between items-center text-white">
                    <h2 class="font-industrial text-xl tracking-wider text-blue-400">>> FIELD NOTES</h2>
                    <span class="text-xs font-mono bg-gray-800 px-2 py-1 border border-gray-600">MEMO BOARD</span>
                </div>

                <div class="p-6 bg-gray-50">
                    <!-- 筆記輸入區 -->
                    <div class="bg-white p-4 border-2 border-gray-300 mb-6 shadow-inner">
                        <input type="text" id="note-author" placeholder="你的名字..." class="bg-transparent border-b-2 border-gray-200 text-black font-bold text-xs w-full mb-2 focus:outline-none focus:border-black transition-colors">
                        <textarea id="note-input" placeholder="輸入筆記內容..." rows="2" 
                            class="w-full bg-transparent text-black font-mono text-sm focus:outline-none resize-none placeholder-gray-400"></textarea>
                        <div class="text-right mt-2">
                            <button onclick="addNote()" class="text-xs bg-black hover:bg-gray-800 text-white px-4 py-2 font-mono font-bold">
                                POST NOTE
                            </button>
                        </div>
                    </div>

                    <!-- 筆記展示區 -->
                    <div id="notes-container" class="grid grid-cols-1 gap-4 max-h-[400px] overflow-y-auto pr-2 custom-scroll">
                        <div class="text-center text-gray-400 font-mono py-4">LOADING NOTES...</div>
                    </div>
                </div>
            </section>
        </div>

        <footer class="mt-12 text-center pb-8">
            <p class="font-mono text-xs text-gray-500 bg-white inline-block px-4 py-1 border border-gray-300">
                MIDDLE EAST FIRE TEAM // SYSTEM ONLINE // VER 2.0
            </p>
        </footer>

    </div>
</body>
</html>
